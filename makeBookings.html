<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="css/bootstrap.css">

    <!-- jQuery library -->
    <script src="js/jquery-2.1.3.js"></script>

    <!-- Latest compiled JavaScript -->
    <script src="js/bootstrap.js"></script>
    <script src="js/bootstrap.min.js"></script>

    <script src="js/date.js"></script>
    <script>
        function fetchRecord(activity) {
            // fake records generator

            var today = Date.today();
            var dates = [];
            var times = [];
            var d;
            for (var i = 0; i < 7; i++) {
                d = today.addDays(i);
                if (d.getDay() != 0 && d.getDay() != 6)
                    dates.push(d.toString("yyyy-MM-dd"));
            }
            for (var h = 8; h <= 21; h++) {
                d.set({ hour: h, minute: 30 });
                times.push(d.toString("HH:mm") + "-" + d.add({ hours: 1 }).toString("HH:mm"));
            }
            var prefix = activity.substr(0, 1).toUpperCase();
            return {
                dates: dates,
                times: times,
                venues: {
                    "Shaw": randomSlots(prefix, dates, times),
                    "Kwong On": randomSlots(prefix, dates, times),
                    "Hall": randomSlots(prefix, dates, times)
                }
            };
        }

        function randomSlots(prefix, dates, times) {
            // fake records generator

            var result = {};
            for (var d = 0; d < dates.length; d++) {
                var date = dates[d];
                var day = result[date] = {};

                for (var t = 0; t < times.length; t++) {
                    var time = times[t];
                    var slots = day[time] = [];
                    if (Math.random() > .5)
                        for (var court = 1; court <= 10; court++) {
                            if (Math.random() > .4) continue;
                            slots.push(prefix + ("00" + court.toString()).slice(-2));
                        }
                }

            }
            return result;
        }
    </script>
    <script type="text/javascript">
        var records = {};
        var selected = {};

        $("document").ready(function () {
            changeTable("#table0");
        });
        function select() {
            $('#addMeeting').hide();
            $('#selectDateTime').show();
        }
        function goBack() {
            $('#addMeeting').show();
            $('#selectDateTime').hide();
            $('#dateTime').val(date + " " + start + ":00-" + end + ":00");

        }

        function changeTable(table) {
            var t = $("#tables").find("[table='" + table + "']");
            $('table').not(t).removeClass('active');
            t.addClass('active');
            var x = $("li[table='" + table + "']");
            x.parent().find("li").removeClass("active");
            x.addClass("active");
        }

        function expand() {
            alert("Right click");
        }

        function getSelectionAsArray() {
            var arr = [];
            for (var k in selected) {
                var key = k.split('|');
                for (var i = 0; i < selected[k].length; i++)
                    arr.push({ venue: key[0], date: key[1], time: key[2], court: selected[k][i] });
            }
            return arr;
        }

        function getSlotSelection(centre, date, time) {
            var key = centre + "|" + date + "|" + time;
            return selected.hasOwnProperty(key) ? (selected[key].length > 0 ? selected[key] : null) : null;
        }

        function setSlotSelection(centre, date, time, courts) {
            var key = centre + "|" + date + "|" + time;
            if (courts && courts.length > 0)
                selected[key] = courts;
            else delete selected[key];
        }

        function selectSlot(target, courts) {
            target = $(target);
            var date = target.attr("date");
            var time = target.attr("time");
            var centre = target.parents("table").attr("table");
            if (courts == null) {
                if (getSlotSelection(centre, date, time)) { // previously selected
                    setSlotSelection(centre, date, time, null);
                } else { // not selected
                    setSlotSelection(centre, date, time, [records.venues[centre][date][time][0]]);
                }
            } else {
                setSlotSelection(centre, date, time, courts);
            }
            // refresh button state
            target.find('input[type=checkbox]').prop('checked', !!getSlotSelection(centre, date, time));
            var selection = getSlotSelection(centre, date, time);
            populateDropdown(
                    target.find('ul'),
                    records.venues[centre][date][time],
                    function (court) {
                        return selection ? selection.indexOf(court) >= 0 : false;
                    });

            // debug
            var s = '';
            var selection = getSelectionAsArray();
            for (var k = 0; k < selection.length; k++) {
                var x = selection[k];
                s += x.venue + " " + x.date + " " + x.time + " " + x.court + "\n";
            }
            if (s == '')
                s = 'Please select a time slot.';
            $("#display").text(s);
        }

        function selectCourt(target, court) {
            target = $(target);
            var date = target.attr("date");
            var time = target.attr("time");
            var centre = target.parents("table").attr("table");

            var courts = getSlotSelection(centre, date, time);
            if (courts == null)
                courts = [court];
            else {
                var i = courts.indexOf(court);
                if (i < 0)
                    courts.push(court);
                else
                    courts.splice(i, 1);
            }
            selectSlot(target, courts);
        }

        function dropdown(target) {
            $(target).dropdown('toggle');
            return false;
        }

        function populateTimetables(data) {
            var tabs = $("#tableTabs");
            var tables = $("#tables");
            tabs.empty();
            tables.empty();

            var first = null;
            for (var k in data.venues) {
                if (!data.venues.hasOwnProperty(k)) continue;

                if (first == null) first = k; // get the first table
                // nav tab
                var tab = $("<li role=\"presentation\"></li>")
                        .appendTo(tabs)
                        .attr("table", k)
                        .append($('<a href="javascript:void(0)" onclick="changeTable(this.parentNode.getAttribute(\'table\'))"></a>').text(k));

                // table
                var table = $('<table class="table table-condensed table-bordered"></table>').attr("table", k)
                        .appendTo(tables);
                populateTimetable(table, data.dates, data.dates, data.times, data.times,
                        function (d, t) {
                            return data.venues[k].hasOwnProperty(d)
                                    && data.venues[k][d].hasOwnProperty(t)
                                    && data.venues[k][d][t].length > 0;
                        },
                        function (d, t) {
                            var key = d + " " + t;
                            return selected.hasOwnProperty(key) && selected[key].length > 0;
                        },
                        function (d, t) {
                            return data.venues[k][d][t];
                        },
                        function (d, t, court) {
                            var key = d + " " + t;
                            return selected.hasOwnProperty(key) && selected[key].indexOf(court >= 0);
                        });
            }

            // preselect first table
            changeTable(first);
        }

        function populateTimetable(table, dates, dateLabels, times, timeLabels,
                                   slotAvailableCallback,
                                   slotSelectedCallback,
                                   slotDropdownListCallback,
                                   slotDropdownListSelectedCallback) {
            var t = $(table);
            t.empty();

            var thead = $("<tr><th>Time\\Date</th></tr>");
            for (var i = 0; i < dates.length; i++)
                thead.append($("<th></th>").text(dateLabels[i]));
            t.append($("<thead></thead>").append(thead));

            var tbody = $("<tbody></tbody>");
            for (var i = 0; i < times.length; i++) {
                var tr = $("<tr></tr>");
                tr.append($("<th scope=\"row\"></th>").text(timeLabels[i]));
                for (var j = 0; j < dates.length; j++) {
                    var td = $("<td></td>").attr("date", dates[j]).attr("time", times[i]);
                    if (slotAvailableCallback(dates[j], times[i])) {
                        td.addClass("success");
                        td.append($('<input type="checkbox" onclick="selectSlot(this.parentNode)" />')
                                .prop('checked', slotSelectedCallback(dates[j], times[i])));
                        var dropdown = $('<span class="dropdown" onclick="dropdown($(this).find(\'ul\'))"></span>');
                        td.append(dropdown);
                        dropdown.append('<span class="glyphicon glyphicon-chevron-down" data-toggle="dropdown"></span>');
                        var ul = $('<ul class="dropdown-menu" role="menu"></ul>');
                        dropdown.append(ul);
                        var list = slotDropdownListCallback(dates[j], times[i]);
                        populateDropdown(ul, list, function (court) {
                            return slotDropdownListSelectedCallback(dates[j], times[i], court);
                        });
                    }
                    tr.append(td);
                }
                tbody.append(tr);
            }
            t.append(tbody);
        }

        function populateDropdown(ul, list, itemCheckedCallback) {
            ul = $(ul);
            ul.empty();
            for (var k = 0; k < list.length; k++) {
                var li = $('<li role="presentation"></li>')
                        .appendTo(ul)
                        .append('<a role="menuitem" onclick="event.stopPropagation(); selectCourt($(this).parents(\'td\')[0], this.parentNode.getAttribute(\'court\')); return false;"></a>')
                        .attr('court', list[k]);
                li.find('a').text(list[k]);
                if (itemCheckedCallback(list[k]))
                    li.addClass('checked');
            }
        }

        function activityChanged() {
            populateTimetables(records = fetchRecord($("#type").val()));
        }

        $(function () {
            $("#type").trigger("change");
        });

    </script>

    <style type="text/css">
        .form-horizontal .control-label {
            /* text-align:right; */
            text-align : left;
        }

        table {
            display : none;
        }

        table.active {
            display : table;
        }

        #bookingTable td {
            text-align : center;
            position   : relative;
        }

        #bookingTable td input[type=checkbox] {
            cursor : pointer;
            width  : 90%;
            height : 90%;
            margin : 0;
        }

        #bookingTable td .dropdown {
            position : absolute;
            right    : 3px;
        }

        #bookingTable td .dropdown li {
            cursor : pointer;
        }

        #bookingTable td .dropdown li.checked a {
            background-color : #428bca;
            color            : white;
        }

        #bookingTable td .dropdown li.checked a:hover {
            background-color : #2a6496;
        }

    </style>
</head>
<body>
    <nav class="navbar navbar-default">
        <div class="container-fluid">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse"
                        data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="#">PolyU System</a>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav">
                    <li><a href="notice.html">Notice</a></li>
                    <li><a href="#" class="active">Inquire/Make Bookings</a></li>
                    <li><a href="myBookings.html">My Bookings</a></li>
                </ul>

                <ul class="nav navbar-nav navbar-right">
                    <li><a href="#" class="text-right">Sign Out</a></li>
                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container-fluid -->
    </nav>
    <div class="container">
        <div class="row">
            <div class="page-header">
                <h1>Inquire/Make Bookings</h1>
            </div>
            <div id="inquiry" class="col-sm-12 col-xs-12">
                <div class="form-horizontal">
                    <div class="form-group">
                        <label for="type" class="col-xs-2 control-label text-left">Activity:</label>

                        <div class="col-xs-9">
                            <select class="form-control" id="type" onchange="activityChanged()">
                                <option>Badminton</option>
                                <option>Fitness training</option>
                                <option>Activities Room</option>
                                <option>Indoor Basketball</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <div id="bookingTable" class="col-sm-12 col-xs-12 table-responsive">
                <ul id="tableTabs" class="nav nav-tabs"></ul>
                <div id="tables" class="table-responsive" style="overflow-y: auto"></div>
                <div>&nbsp;</div>

                <button type="button" class="btn btn-primary btn-lg" onclick="goBack()">clear</button>
                <button type="button" class="btn btn-primary btn-lg"
                        onclick="if(getSelectionAsArray().length==0) { alert('Please select at least one time slot'); return false; }"
                        style="float:right;">Book
                </button>
            </div>
        </div>
        <div>&nbsp;</div>
        <pre id="display">Please select a time slot.</pre>
    </div>
</body>
</html>
