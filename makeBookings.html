<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="css/bootstrap.css">
    <link rel="stylesheet" href="css/global.css">
    <!--<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">-->
    <!-- jQuery library -->
    <script src="js/jquery-2.1.3.js"></script>

    <!-- Latest compiled JavaScript -->
    <script src="js/bootstrap.js"></script>
    <!--<script src="js/bootstrap.min.js"></script>-->

    <script src="js/date.js"></script>
    <!--<script src="sampledata.js"></script>-->

    <script type="text/javascript">
        var records = {};
        var selected = {};

        function changeTable(table) {
            var t = $("#tables").find("[table='" + table + "']");
            $('table').not(t).removeClass('active');
            t.addClass('active');
            var x = $("li[table='" + table + "']");
            x.parent().find("li").removeClass("active");
            x.addClass("active");
        }

        function clearSelection() {
            selected = {};
            populateTimetables(records, $("#tableTabs li.active").attr('table'));
            displaySelected();
        }

        function getSelectionAsArray() {
            var arr = [];
            for (var k in selected) {
                var key = k.split('|');
                for (var i = 0; i < selected[k].length; i++)
                    arr.push({
                        venue: key[0],
                        date: key[1],
                        time: key[2],
                        court: selected[k][i],
                        d: Date.parseExact(key[1] + key[2], 'yyyy-MM-ddHH:mm')
                    });
            }
            arr.sort(function (a, b) {
                return a.d.getTime() != +b.d.getTime() ? (a.d < b.d ? -1 : 1) :
                       (a.venue != b.venue ? (a.venue < b.venue ? -1 : 1) :
                        (a.court != b.court ? (a.court < b.court ? -1 : 1) : 0));
            });
            return arr;
        }

        function getSlotSelection(centre, date, time) {
            var key = centre + "|" + date + "|" + time;
            return selected.hasOwnProperty(key) ? (selected[key].length > 0 ? selected[key] : null) : null;
        }

        function setSlotSelection(centre, date, time, courts) {
            var key = centre + "|" + date + "|" + time;
            if (courts && courts.length > 0)
                selected[key] = courts;
            else delete selected[key];
        }

        function selectSlot(target, courts) {
            target = $(target);
            var date = target.attr("date");
            var time = target.attr("time");
            var centre = target.parents("table").attr("table");
            if (courts == null) {
                var previous = getSlotSelection(centre, date, time);
                if (previous) { // previously selected
                    if (previous.length == 1 && previous[0] == records.venues[centre][date][time][0])
                    // if default selection then toggle
                        setSlotSelection(centre, date, time, null);
                    else
                    // not default means the user has chosen custom court from dropdown, then open the dropdown instead
                        return dropdown(target.find('ul.dropdown-menu'));
                } else { // not selected
                    setSlotSelection(centre, date, time, [records.venues[centre][date][time][0]]);
                }
            } else {
                setSlotSelection(centre, date, time, courts);
            }
            // refresh button state
            target.find('input[type=checkbox]').prop('checked', !!getSlotSelection(centre, date, time));
            var selection = getSlotSelection(centre, date, time);
            populateDropdown(
                    target.find('ul'),
                    records.venues[centre][date][time],
                    function (court) {
                        return selection ? selection.indexOf(court) >= 0 : false;
                    });

            displaySelected();
        }

        function displaySelected() {
            // display selected
            var s = '';
            var selection = getSelectionAsArray();
            for (var k = 0; k < selection.length; k++) {
                var x = selection[k];
                s += x.d.toString('yyyy/MM/dd (ddd) HH:mm')
                + x.d.clone().add({ hours: 1 }).toString('-HH:mm ')
                + x.venue
                + " "
                + x.court
                + "\n";
            }
            if (s == '')
                s = 'Please select a time slot.';
            $("#display").text(s);
        }

        function selectCourt(target, court) {
            target = $(target);
            var date = target.attr("date");
            var time = target.attr("time");
            var centre = target.parents("table").attr("table");

            var courts = getSlotSelection(centre, date, time);
            if (courts == null)
                courts = [court];
            else {
                var i = courts.indexOf(court);
                if (i < 0)
                    courts.push(court);
                else
                    courts.splice(i, 1);
            }
            selectSlot(target, courts);
        }

        function dropdown(target) {
            event.stopPropagation();
            event.preventDefault();
            $(target).dropdown('toggle');
            return false;
        }

        function populateTimetables(data, selecttable) {
            var tabs = $("#tableTabs");
            var tables = $("#tables");
            tabs.empty();
            tables.empty();

            var first = null;
            for (var k in data.venues) {
                if (!data.venues.hasOwnProperty(k)) continue;

                if (first == null) first = k; // get the first table
                // nav tab
                var tab = $("<li role=\"presentation\"></li>")
                        .appendTo(tabs)
                        .attr("table", k)
                        .append($('<a href="javascript:void(0)" onclick="changeTable(this.parentNode.getAttribute(\'table\'))"></a>').text(k));

                // table
                var table = $('<table class="table table-condensed table-bordered"></table>').attr("table", k)
                        .appendTo(tables);
                var dateLabels = [];
                for (var q = 0; q < data.dates.length; q++) {
                    var d = Date.parseExact(data.dates[q], 'yyyy-MM-dd');
                    dateLabels.push(d.toString('d/M (ddd)'));
                }
                var timeLabels = [];
                for (var q = 0; q < data.times.length; q++) {
                    var d = Date.parseExact(data.times[q], 'HH:mm');
                    timeLabels.push(data.times[q] + '-' + d.add({ hours: 1 }).toString('HH:mm'));
                }
                populateTimetable(table, data.dates, dateLabels, data.times, timeLabels,
                        function (d, t) {
                            return data.venues[k].hasOwnProperty(d)
                                    && data.venues[k][d].hasOwnProperty(t)
                                    && data.venues[k][d][t].length > 0;
                        },
                        function (d, t) {
                            var key = d + " " + t;
                            return selected.hasOwnProperty(key) && selected[key].length > 0;
                        },
                        function (d, t) {
                            return data.venues[k][d][t];
                        },
                        function (d, t, court) {
                            var key = d + " " + t;
                            return selected.hasOwnProperty(key) && selected[key].indexOf(court >= 0);
                        });
            }

            // preselect first table
            changeTable(selecttable ? selecttable : first);
        }

        function populateTimetable(table, dates, dateLabels, times, timeLabels,
                                   slotAvailableCallback,
                                   slotSelectedCallback,
                                   slotDropdownListCallback,
                                   slotDropdownListSelectedCallback) {
            var t = $(table);
            t.empty();

            var thead = $("<tr><th>Time \\ Date</th></tr>");
            for (var i = 0; i < dates.length; i++)
                thead.append($("<th></th>").text(dateLabels[i]));
            t.append($("<thead></thead>").append(thead));

            var tbody = $("<tbody></tbody>");
            for (var i = 0; i < times.length; i++) {
                var tr = $("<tr></tr>");
                tr.append($("<th scope=\"row\"></th>").text(timeLabels[i]));
                for (var j = 0; j < dates.length; j++) {
                    var td = $('<td></td>').attr("date", dates[j]).attr("time", times[i]);
                    if (slotAvailableCallback(dates[j], times[i])) {
                        td.addClass("success");
                        td.attr('onclick', 'selectSlot(this)');
                        td.append($('<input type="checkbox" onclick=""/>').prop('checked', slotSelectedCallback(dates[j], times[i])));
                        var dropdown = $('<span class="dropdown" onclick="return dropdown($(this).find(\'ul\'))"></span>');
                        td.append(dropdown);

                        dropdown.append('<span class="glyphicon glyphicon-triangle-bottom" data-toggle="dropdown"></span>');
                        var ul = $('<ul class="dropdown-menu dropdown-menu-right" role="menu"></ul>');
                        dropdown.append(ul);
                        var list = slotDropdownListCallback(dates[j], times[i]);
                        populateDropdown(ul, list, function (court) {
                            return slotDropdownListSelectedCallback(dates[j], times[i], court);
                        });
                    }
                    tr.append(td);
                }
                tbody.append(tr);
            }
            t.append(tbody);
        }

        function populateDropdown(ul, list, itemCheckedCallback) {
            ul = $(ul);
            ul.empty();
            for (var k = 0; k < list.length; k++) {
                var li = $('<li role="presentation"></li>')
                        .appendTo(ul)
                        .append('<a role="menuitem" onclick="event.stopPropagation(); selectCourt($(this).parents(\'td\')[0], this.parentNode.getAttribute(\'court\')); return false;"></a>')
                        .attr('court', list[k]);
                li.find('a').text(list[k]);
                if (itemCheckedCallback(list[k]))
                    li.addClass('checked');
            }
        }

        function activityChanged() {
            if (getSelectionAsArray().length > 0)
                if (!confirm('Changing the filter will clear the selection. Continue?'))
                    return false;

            selected = {};
            displaySelected();
            $("#tableTabs").empty();
            $("#tables").empty();


            $.ajax({
                url: 'do.php?action=list',
                data: { activity: $("#type").val() },
                success: function (data) {
                    populateTimetables(records = data);
                },
                error: function (xhr, status, error) {
                    alert("Cannot get available time slots:\n" + xhr.responseText != '' ? xhr.responseText : error);
                }
            });

            return true;
        }
    </script>

    <style type="text/css">
        .form-horizontal .control-label {
            /* text-align:right; */
            text-align : left;
        }

        #tableTabs a {
            font-size : 1.2em;
        }

        table {
            display : none;
        }

        table.active {
            display : table;
        }

        #bookingTable {
            padding : 0;
        }

        #bookingTable td {
            text-align     : center;
            position       : relative;
            vertical-align : middle;
        }

        #bookingTable td.success {
            cursor : pointer;
        }

        #bookingTable td.success:hover {
            background-color : #d5e6cf;
        }

        #bookingTable td input[type=checkbox] {
            margin : 0;
        }

        #bookingTable td .dropdown {
            float : right;
        }

        #bookingTable td .dropdown > span {
            font-size : .6em;
        }

        #bookingTable td .dropdown li {
            cursor : pointer;
        }

        #bookingTable td .dropdown li.checked a {
            background-color : #428bca;
            color            : white;
        }

        #bookingTable td .dropdown li.checked a:hover {
            background-color : #2a6496;
        }

        #bookingTable .dropdown ul {
            min-width : inherit;
        }

        @media (max-width : 480px) {
            #bookingTable th {
                font-size : .8em !important;
            }

            #bookingTable td .dropdown {
                right : 0px;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-inverse">
        <div class="container-fluid">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse"
                        data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="./">PolyU System</a>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav">
                    <li><a href="notice.html">Notice</a></li>
                    <li><a class="active">Inquire/Make Bookings</a></li>
                    <li><a href="myBookings.html">My Bookings</a></li>
                </ul>

                <ul class="nav navbar-nav navbar-right">
                    <li><a href="#" class="text-right">Sign Out</a></li>
                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container-fluid -->
    </nav>
    <div class="container">
        <div class="row">
            <div class="page-header col-xs-12">
                <h1>Inquire/Make Bookings</h1>
            </div>
            <div id="inquiry" class="col-sm-12 col-xs-12">
                <div class="form-horizontal">
                    <div class="form-group">
                        <label for="type" class="col-xs-2 control-label text-left">Activity:</label>

                        <div class="col-xs-9">
                            <select class="form-control" id="type">
                                <option>Badminton</option>
                                <option>Fitness training</option>
                                <option>Activities Room</option>
                                <option>Indoor Basketball</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <div id="bookingTable" class="col-sm-12 col-xs-12">
                <ul id="tableTabs" class="nav nav-tabs"></ul>
                <div id="tables"></div>
                <div>&nbsp;</div>
                <div class="col-xs-12">
                    <button type="button" class="btn btn-primary btn-lg" onclick="clearSelection()">clear</button>
                    <button type="button" class="btn btn-primary btn-lg"
                            onclick="if(getSelectionAsArray().length==0) { alert('Please select at least one time slot'); return false; } else window.location.href = 'successBooking.html';"
                            style="float:right;">Book
                    </button>
                </div>
            </div>
        </div>
        <div>&nbsp;</div>
        <h3>Selected time slots:</h3>
        <pre id="display">Please select a time slot.</pre>
    </div>
    <script type="text/javascript">

        $("#type").change(function () {
            if (!activityChanged()) {
                event.preventDefault();
                event.stopPropagation();
                $("#type").data().attr("selected", true);
            }
        }).click(function () {
            $("#type").data($("#type option:selected"));
        });

        $("#type").trigger("change");

    </script>
</body>
</html>
